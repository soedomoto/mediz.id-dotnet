@page "/dashboard"
@layout AuthenticatedLayout
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager
@inject DashboardService DashboardService
@using MedizID.UI.Services
@using AntDesign.Charts
@using MedizID.UI.Services.Generated.Models
@implements IAsyncDisposable

<PageTitle>MedizID - Dashboard</PageTitle>

@if (!isAuthenticated)
{
    <div style="text-align: center; padding: 48px 24px;">
        <Alert Message="Access Denied" Description="You need to be logged in to view this page." Type="AlertType.Warning"
            ShowIcon="true" />
        <Button Type="ButtonType.Primary" Style="margin-top: 16px;"
            @onclick="@(() => NavigationManager.NavigateTo("/login"))">Go to Login</Button>
    </div>
}
else if (isLoading)
{
    <div style="text-align: center; padding: 48px 24px;">
        <Spin Delay="0" />
        <p style="margin-top: 16px;">Loading dashboard...</p>
    </div>
}
else
{
    <!-- Welcome Section -->
    <div style="margin-bottom: 24px;">
        <h1>Welcome, @userFirstName!</h1>
        <p style="color: #8c8c8c; font-size: 14px;">@GetWelcomeMessage()</p>
    </div>

    <!-- Role Selector -->
    <Card Style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <span style="font-weight: 500;">View Statistics for:</span>
            <Select TItemValue="string" TItem="string" Value="@selectedRole" Style="min-width: 250px;"
                OnSelectedItemChanged="@(e => OnRoleChanged(e))">
                @foreach (var roleValue in Enum.GetValues(typeof(UserRoleEnum)))
                {
                    var roleString = ((UserRoleEnum)roleValue).ToString();
                    <SelectOption TItemValue="string" TItem="string" Value="@roleString">@GetRoleDisplayName(roleString)</SelectOption>
                }
            </Select>
            <Tag Color="@("blue")" Style="padding: 4px 12px;">@GetRoleDescription(selectedRole)</Tag>
        </div>
    </Card>

    <!-- Multi-Role Dashboard: Shows all applicable statistics -->

    <!-- Facility Owner / Superuser Section -->
    @if (selectedRole == "FacilityOwner" || selectedRole == "SuperAdmin")
    {
        <div style="margin-bottom: 32px;">
            <h2 style="margin-bottom: 16px;">üìã Facility Management Overview</h2>
            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Managed Facilities" Value="@facilityOwnerStats?.ManagedFacilitiesCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Total Patients" Value="@facilityOwnerStats?.TotalPatientsCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Total Staff" Value="@facilityOwnerStats?.TotalStaffCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Today's Appointments" Value="@facilityOwnerStats?.TodayAppointmentsCount"
                            ValueStyle="@($"color: #1890ff;")" />
                    </Card>
                </AntDesign.Col>
            </Row>

            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="12">
                    <Card Title="Appointment Status Distribution" Loading="statsLoading" Style="height: 100%;">
                        @if (ownerAppointmentChartData != null && ownerAppointmentChartData.Any())
                        {
                            <div
                                style="display: flex; justify-content: space-around; align-items: flex-end; height: 250px; gap: 16px;">
                                @foreach (var data in ownerAppointmentChartData)
                                {
                                    var maxValue = ownerAppointmentChartData.Max(x => x.Value);
                                    var barHeight = maxValue > 0 ? (data.Value * 200.0) / maxValue : 0;
                                    var color = data.Label == "Completed" ? "#52c41a" : data.Label == "Pending" ? "#faad14" : "#ff4d4f";

                                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                                        <div
                                            style="@($"height: {barHeight}px; width: 100%; background-color: {color}; border-radius: 4px; min-height: 20px;")">
                                        </div>
                                        <span style="margin-top: 8px; font-weight: 500;">@data.Label</span>
                                        <span style="color: #999; font-size: 12px;">@data.Value</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div style="text-align: center; padding: 24px; color: #999;">
                                <p>No appointment data available</p>
                            </div>
                        }
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="12">
                    <Card Title="Key Metrics" Loading="statsLoading">
                        <Descriptions>
                            <DescriptionsItem Title="Pending Appointments">
                                <Tag Color="@("orange")">@facilityOwnerStats?.PendingAppointmentsCount</Tag>
                            </DescriptionsItem>
                            <DescriptionsItem Title="Completed Appointments">
                                <Tag Color="@("green")">@facilityOwnerStats?.CompletedAppointmentsCount</Tag>
                            </DescriptionsItem>
                            <DescriptionsItem Title="Cancelled Appointments">
                                <Tag Color="@("red")">@facilityOwnerStats?.CancelledAppointmentsCount</Tag>
                            </DescriptionsItem>
                            <DescriptionsItem Title="Total Appointments">
                                <strong>@((facilityOwnerStats?.PendingAppointmentsCount ?? 0) + (facilityOwnerStats?.CompletedAppointmentsCount ?? 0) + (facilityOwnerStats?.CancelledAppointmentsCount ?? 0))</strong>
                            </DescriptionsItem>
                        </Descriptions>
                    </Card>
                </AntDesign.Col>
            </Row>
        </div>
    }

    <!-- Doctor Statistics Section -->
    @if (selectedRole == "Doctor")
    {
        <div style="margin-bottom: 32px;">
            <h2 style="margin-bottom: 16px;">üë®‚Äç‚öïÔ∏è Doctor Dashboard</h2>
            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Staffed Facilities" Value="@doctorStats.StaffedFacilitiesCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Today's Appointments" Value="@doctorStats.TodayAppointmentsCount"
                            ValueStyle="@($"color: #1890ff;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Completed" Value="@doctorStats.CompletedAppointmentsCount"
                            ValueStyle="@($"color: #52c41a;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Patients Seen" Value="@doctorStats.PatientsSeenCount" />
                    </Card>
                </AntDesign.Col>
            </Row>

            <Card Title="Doctor Appointment Completion Rate" Loading="statsLoading" Style="margin-bottom: 24px;">
                <AntDesign.Progress Percent="@GetDoctorCompletionRate()"
                    Status="@(GetDoctorCompletionRate() >= 50 ? ProgressStatus.Success : ProgressStatus.Active)" />
            </Card>
        </div>
    }

    <!-- Midwife Statistics Section -->
    @if (selectedRole == "Midwife")
    {
        <div style="margin-bottom: 32px;">
            <h2 style="margin-bottom: 16px;">üë©‚Äç‚öïÔ∏è Midwife Dashboard</h2>
            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Staffed Facilities" Value="@midwifeStats.StaffedFacilitiesCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Today's Appointments" Value="@midwifeStats.TodayAppointmentsCount"
                            ValueStyle="@($"color: #1890ff;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Completed" Value="@midwifeStats.CompletedAppointmentsCount"
                            ValueStyle="@($"color: #52c41a;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Patients Seen" Value="@midwifeStats.PatientsSeenCount" />
                    </Card>
                </AntDesign.Col>
            </Row>

            <Card Title="Midwife Appointment Completion Rate" Loading="statsLoading" Style="margin-bottom: 24px;">
                <AntDesign.Progress Percent="@GetMidwifeCompletionRate()"
                    Status="@(GetMidwifeCompletionRate() >= 50 ? ProgressStatus.Success : ProgressStatus.Active)" />
            </Card>
        </div>
    }

    <!-- Nurse Statistics Section -->
    @if (selectedRole == "Nurse")
    {
        <div style="margin-bottom: 32px;">
            <h2 style="margin-bottom: 16px;">üè• Nurse Dashboard</h2>
            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Staffed Facilities" Value="@nurseStats.StaffedFacilitiesCount" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Today's Appointments" Value="@nurseStats.TodayAppointmentsCount"
                            ValueStyle="@($"color: #1890ff;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Completed" Value="@nurseStats.CompletedAppointmentsCount"
                            ValueStyle="@($"color: #52c41a;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Patients Seen" Value="@nurseStats.PatientsSeenCount" />
                    </Card>
                </AntDesign.Col>
            </Row>

            <Card Title="Nurse Appointment Completion Rate" Loading="statsLoading" Style="margin-bottom: 24px;">
                <AntDesign.Progress Percent="@GetNurseCompletionRate()"
                    Status="@(GetNurseCompletionRate() >= 50 ? ProgressStatus.Success : ProgressStatus.Active)" />
            </Card>
        </div>
    }

    <!-- Patient Appointments Section -->
    @if (selectedRole == "Patient")
    {
        <div style="margin-bottom: 32px;">
            <h2 style="margin-bottom: 16px;">üìÖ Your Appointments</h2>
            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Total Appointments" Value="@((patientStats?.UpcomingAppointmentsCount ?? 0) + (patientStats?.CompletedAppointmentsCount ?? 0) + (patientStats?.CancelledAppointmentsCount ?? 0))" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Upcoming" Value="@patientStats?.UpcomingAppointmentsCount"
                            ValueStyle="@($"color: #1890ff;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Completed" Value="@patientStats?.CompletedAppointmentsCount"
                            ValueStyle="@($"color: #52c41a;")" />
                    </Card>
                </AntDesign.Col>
                <AntDesign.Col Span="6">
                    <Card Loading="statsLoading">
                        <Statistic Title="Today" Value="@patientStats?.CancelledAppointmentsCount" />
                    </Card>
                </AntDesign.Col>
            </Row>

            <Row Gutter="16" Style="margin-bottom: 24px;">
                <AntDesign.Col Span="12">
                    <Card Title="Appointment Status Summary" Loading="statsLoading">
                        @if (patientAppointmentChartData != null && patientAppointmentChartData.Any())
                        {
                            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 24px;">
                                @foreach (var data in patientAppointmentChartData)
                                {
                                    var totalAppointments = patientAppointmentChartData.Sum(x => x.Value);
                                    var percentage = totalAppointments > 0 ? (int)((data.Value * 100.0) / totalAppointments) : 0;
                                    var color = data.Label == "Completed" ? "#52c41a" : data.Label == "Upcoming" ? "#1890ff" :
                                    "#ff4d4f";

                                    <div style="text-align: center; flex: 1; min-width: 120px;">
                                        <div
                                            style="@($"width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, {color} 0%, rgba(0,0,0,0.1) 100%); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white;")">
                                            @percentage%
                                        </div>
                                        <span style="display: block; font-weight: 500; margin-bottom: 4px;">@data.Label</span>
                                        <span style="color: #999; font-size: 12px;">@data.Value appointments</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <Descriptions>
                                <DescriptionsItem Title="Upcoming">
                                    <Tag Color="@("blue")">@patientStats?.UpcomingAppointmentsCount</Tag>
                                </DescriptionsItem>
                                <DescriptionsItem Title="Completed">
                                    <Tag Color="@("green")">@patientStats?.CompletedAppointmentsCount</Tag>
                                </DescriptionsItem>
                                <DescriptionsItem Title="Cancelled">
                                    <Tag Color="@("red")">@patientStats?.CancelledAppointmentsCount</Tag>
                                </DescriptionsItem>
                            </Descriptions>
                        }
                    </Card>
                </AntDesign.Col>
            </Row>
        </div>
    }

    <!-- Quick Actions -->
    <Card Title="Quick Actions" Style="margin-top: 24px; margin-bottom: 24px;">
        <Space Wrap="true">
            <SpaceItem>
                <Button Type="ButtonType.Primary" Icon="project">
                    <NavLink href="/facilities">Manage Facilities</NavLink>
                </Button>
            </SpaceItem>
            <SpaceItem>
                <Button Icon="team">
                    <NavLink href="/staff">Manage Staff</NavLink>
                </Button>
            </SpaceItem>
            <SpaceItem>
                <Button Type="ButtonType.Primary" Icon="calendar">
                    <NavLink href="/appointments">View Appointments</NavLink>
                </Button>
            </SpaceItem>
            <SpaceItem>
                <Button Icon="user">
                    <NavLink href="/patients">View Patients</NavLink>
                </Button>
            </SpaceItem>
        </Space>
    </Card>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool statsLoading = true;
    private string? userFirstName;

    // Role selector
    private string selectedRole = "Patient";

    private FacilityOwnerStatisticsDto? facilityOwnerStats;
    private DoctorStatisticsDto? doctorStats;
    private MidwifeStatisticsDto? midwifeStats;
    private NurseStatisticsDto? nurseStats;
    private PatientAppointmentStatisticsDto? patientStats;

    // Chart data
    private List<ChartDataPoint> ownerAppointmentChartData = new();
    private List<ChartDataPoint> patientAppointmentChartData = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            // Get current user
            var user = await DashboardService.GetCurrentUserAsync();
            isAuthenticated = user is not null && !string.IsNullOrEmpty(user.Token);

            if (!isAuthenticated)
            {
                isLoading = false;
                return;
            }

            userFirstName = user?.FirstName ?? "User";

            // Load statistics for the initial selected role
            await LoadRoleStatistics(selectedRole);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            statsLoading = false;
        }
    }

    private async Task LoadRoleStatistics(string role)
    {
        Console.WriteLine($"Loading statistics for role: {role}");

        statsLoading = true;
        try
        {
            // Clear previous data
            facilityOwnerStats = new();
            doctorStats = new();
            midwifeStats = new();
            nurseStats = new();
            patientStats = new();
            ownerAppointmentChartData = new();
            patientAppointmentChartData = new();

            // Load statistics based on the selected role
            if (role == "FacilityOwner" || role == "SuperAdmin")
            {
                facilityOwnerStats = await DashboardService.GetFacilityOwnerStatisticsAsync();
                if (facilityOwnerStats != null)
                {
                    ownerAppointmentChartData = new()
                    {
                        new ChartDataPoint { Label = "Pending", Value = facilityOwnerStats.PendingAppointmentsCount },
                        new ChartDataPoint { Label = "Completed", Value = facilityOwnerStats.CompletedAppointmentsCount },
                        new ChartDataPoint { Label = "Cancelled", Value = facilityOwnerStats.CancelledAppointmentsCount }
                    };
                }
            }
            else if (role == "Doctor")
            {
                doctorStats = await DashboardService.GetDoctorStatisticsAsync();
            }
            else if (role == "Midwife")
            {
                midwifeStats = await DashboardService.GetMidwifeStatisticsAsync();
            }
            else if (role == "Nurse")
            {
                nurseStats = await DashboardService.GetNurseStatisticsAsync();
            }
            else if (role == "Patient")
            {
                patientStats = await DashboardService.GetPatientAppointmentStatisticsAsync();
                if (patientStats != null)
                {
                    patientAppointmentChartData = new()
                    {
                        new ChartDataPoint { Label = "Upcoming", Value = patientStats.UpcomingAppointmentsCount },
                        new ChartDataPoint { Label = "Completed", Value = patientStats.CompletedAppointmentsCount },
                        new ChartDataPoint { Label = "Cancelled", Value = patientStats.CancelledAppointmentsCount }
                    };
                }
            }
        }
        finally
        {
            statsLoading = false;
        }
    }

    private string GetWelcomeMessage()
    {
        var hour = DateTime.Now.Hour;
        var greeting = hour < 12 ? "Good morning" : hour < 18 ? "Good afternoon" : "Good evening";
        return $"{greeting}! Welcome to MedizID. Select a role to view statistics.";
    }

    private int GetDoctorCompletionRate()
    {
        if (doctorStats?.TodayAppointmentsCount == null || doctorStats.TodayAppointmentsCount == 0)
            return 0;
        return (int)((doctorStats.CompletedAppointmentsCount ?? 0) * 100.0 / (doctorStats.TodayAppointmentsCount ?? 1));
    }

    private int GetMidwifeCompletionRate()
    {
        if (midwifeStats?.TodayAppointmentsCount == null || midwifeStats.TodayAppointmentsCount == 0)
            return 0;
        return (int)((midwifeStats.CompletedAppointmentsCount ?? 0) * 100.0 / (midwifeStats.TodayAppointmentsCount ?? 1));
    }

    private int GetNurseCompletionRate()
    {
        if (nurseStats?.TodayAppointmentsCount == null || nurseStats.TodayAppointmentsCount == 0)
            return 0;
        return (int)((nurseStats.CompletedAppointmentsCount ?? 0) * 100.0 / (nurseStats.TodayAppointmentsCount ?? 1));
    }

    private async Task OnRoleChanged(string? value)
    {
        Console.WriteLine($"Role changed to: {value}");

        if (!string.IsNullOrEmpty(value))
        {
            selectedRole = value;
            await LoadRoleStatistics(value);
        }
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "FacilityOwner" => "üìã Facility Owner",
            "SuperAdmin" => "üëë Super Admin",
            "Doctor" => "üë®‚Äç‚öïÔ∏è Doctor",
            "Midwife" => "üë©‚Äç‚öïÔ∏è Midwife",
            "Nurse" => "üè• Nurse",
            "Pharmacist" => "üíä Pharmacist",
            "LaboratoryTechnician" => "üî¨ Laboratory Technician",
            "Radiologist" => "üìª Radiologist",
            "Physiotherapist" => "ü§ï Physiotherapist",
            "Receptionist" => "üíº Receptionist",
            "Patient" => "üë§ Patient",
            _ => role
        };
    }

    private string GetRoleDescription(string role)
    {
        return role switch
        {
            "FacilityOwner" => "Facility management & oversight",
            "SuperAdmin" => "Platform administration",
            "Doctor" => "Medical consultation & diagnosis",
            "Midwife" => "Maternal & child health",
            "Nurse" => "Patient care & support",
            "Pharmacist" => "Medication management",
            "LaboratoryTechnician" => "Laboratory services",
            "Radiologist" => "Imaging services",
            "Physiotherapist" => "Rehabilitation services",
            "Receptionist" => "Front desk operations",
            "Patient" => "Personal appointments",
            _ => "Role statistics"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        await Task.CompletedTask;
    }
}