@page "/facilities/{FacilityId:guid}/appointment"
@using System.Threading.Tasks
@using MedizID.UI.Services.Generated.Models
@layout FacilityLayout
@inject ILocalStorageService LocalStorage
@inject MedizIdApiClient ApiClient
@inject FacilityLayoutState LayoutState
@inject INotificationService _notice
@inject ModalService _modalService
@implements IAsyncDisposable

<PageTitle>@(LayoutState.Facility != null ? LayoutState.Facility.Name + " - Appointment" : "MedizID")</PageTitle>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h2>Appointments</h2>
    <Button Type="ButtonType.Primary" @onclick="OpenAddAppointmentModal">
        + Add Appointment
    </Button>
</div>

<Table @ref="appointmentTable" TItem="AppointmentResponse" DataSource="appointmentTableDS" PageSize="10"
    Total="appointmentTableTotal" OnChange="OnAppointmentTableChange" ScrollX="1500">
    <ColumnDefinitions Context="row">
        <Column Title="Patient Name" TData="FacilityResponse">
            <NavLink href="@($"/appointments/{row?.Id}")">@row?.PatientName</NavLink>
        </Column>
        <Column Title="Doctor Name" DataIndex="@nameof(AppointmentResponse.DoctorName)" TData="string" />
        <Column Title="Appointment Date" TData="DateTimeOffset">
            @{
                var dateStr = row?.AppointmentDate?.ToString(@"yyyy-MM-dd");
                <text>@dateStr</text>
            }
        </Column>
        <Column Title="Appointment Time" TData="string">
            @row?.AppointmentTime
        </Column>
        <Column Title="Status" DataIndex="@nameof(AppointmentResponse.Status)" TData="string" />
        <Column Title="Reason" DataIndex="@nameof(AppointmentResponse.Reason)" TData="string" />
        <Column Title="Actions" TData="AppointmentResponse">
            <Space>
                <SpaceItem>
                    <Button Type="ButtonType.Primary" Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenUpdateAppointmentModal(row))">
                        Edit
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Danger Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenDeleteAppointmentModal(row))">
                        Delete
                    </Button>
                </SpaceItem>
            </Space>
        </Column>
    </ColumnDefinitions>
</Table>

<Modal Title="Add New Appointment" Visible="isAddAppointmentModalVisible" OnOk="OnAddAppointmentSaveClick"
    OnCancel="CloseAddAppointmentModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(addAppointmentErrorMessage))
    {
        <Alert Message="Error" Description="@addAppointmentErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="newAppointment" Layout="FormLayout.Vertical">
        <FormItem Label="Patient" Required>
            <AutoComplete @bind-Value="@newAppointmentPatientKeyword" OnInput="OnNewAppointmentPatientSearch"
                Options="@newAppointmentPatientOptions"
                OnSelectionChange="@((AutoCompleteOption item) => OnNewAppointmentPatientSelected(item))"
                Placeholder="Search patient by name" DebounceMilliseconds="300">
                <OptionTemplate Context="option">
                    <AutoCompleteOption Value="@option.Value.Id" Label="@($"{option.Value.PatientName}")" />
                </OptionTemplate>
            </AutoComplete>
        </FormItem>
        <FormItem Label="Doctor">
            <AutoComplete @bind-Value="@newAppointmentDoctorKeyword" OnInput="OnNewAppointmentDoctorSearch"
                Options="@newAppointmentDoctorOptions"
                OnSelectionChange="@((AutoCompleteOption item) => OnNewAppointmentDoctorSelected(item))"
                Placeholder="Search doctor by name" DebounceMilliseconds="300">
                <OptionTemplate Context="option">
                    <AutoCompleteOption Value="@option.Value.Id" Label="@($"{option.Value.StaffName}")" />
                </OptionTemplate>
            </AutoComplete>
        </FormItem>
        <FormItem Label="Appointment Date" Required>
            <DatePicker TValue="DateTimeOffset ?" @bind-Value="newAppointmentDate" ShowTime="false" />
        </FormItem>
        <FormItem Label="Appointment Time" Required>
            <Input @bind-Value="@newAppointmentTimeString" Placeholder="HH:mm" />
        </FormItem>
        <FormItem Label="Reason">
            <TextArea @bind-Value="@newAppointment.Reason" Placeholder="Appointment reason" />
        </FormItem>
        <FormItem Label="Notes">
            <TextArea @bind-Value="@newAppointment.Notes" Placeholder="Additional notes" />
        </FormItem>
    </Form>
</Modal>

<Modal Title="Update Appointment" Visible="isUpdateAppointmentModalVisible" OnOk="OnUpdateAppointmentSaveClick"
    OnCancel="CloseUpdateAppointmentModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(updateAppointmentErrorMessage))
    {
        <Alert Message="Error" Description="@updateAppointmentErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="updateAppointment" Layout="FormLayout.Vertical">
        <FormItem Label="Appointment Date">
            <DatePicker TValue="DateTimeOffset ?" @bind-Value="@updateAppointment.AppointmentDate" ShowTime="false" />
        </FormItem>
        <FormItem Label="Appointment Time">
            <Input @bind-Value="@updateAppointmentTimeString" Placeholder="HH:mm" />
        </FormItem>
        <FormItem Label="Status">
            <Select @bind-Value="@updateAppointment.Status" TItemValue="string" TItem="string"
                Placeholder="Select status">
                <SelectOption TItemValue="string" TItem="string" Value="@("Pending")" Label="Pending" />
                <SelectOption TItemValue="string" TItem="string" Value="@("Confirmed")" Label="Confirmed" />
                <SelectOption TItemValue="string" TItem="string" Value="@("Completed")" Label="Completed" />
                <SelectOption TItemValue="string" TItem="string" Value="@("Cancelled")" Label="Cancelled" />
            </Select>
        </FormItem>
        <FormItem Label="Reason">
            <TextArea @bind-Value="@updateAppointment.Reason" Placeholder="Appointment reason" />
        </FormItem>
        <FormItem Label="Notes">
            <TextArea @bind-Value="@updateAppointment.Notes" Placeholder="Additional notes" />
        </FormItem>
    </Form>
</Modal>

<Modal Title="Delete Appointment" Visible="isDeleteAppointmentModalVisible" OnOk="OnDeleteAppointmentConfirm"
    OnCancel="CloseDeleteAppointmentModal" OkButtonProps="new ButtonProps { Danger = true }" OkText="@("Delete")"
    CancelText="@("Cancel")" BodyStyle="max-height: 60vh; overflow-y: auto;">
    <div>
        <p>Are you sure you want to delete this appointment?</p>
        <p style="color: #ff4d4f; font-weight: bold;">This action cannot be undone.</p>
    </div>
</Modal>

@code {
    [Parameter]
    public Guid FacilityId { get; set; }

    // Table-related fields
    ITable? appointmentTable;
    List<AppointmentResponse> appointmentTableDS = [];
    int appointmentTableTotal = 0;

    // Add new appointment modal and form-related fields
    string? newAppointmentPatientKeyword;
    List<FacilityPatientResponse> newAppointmentPatientOptions = [];
    string? newAppointmentDoctorKeyword;
    List<FacilityStaffResponse> newAppointmentDoctorOptions = [];
    DateTimeOffset? newAppointmentDate;
    string? newAppointmentTimeString;

    async Task OnNewAppointmentPatientSearch(ChangeEventArgs e)
    {
        newAppointmentPatientOptions = await SearchPatients(e.Value?.ToString());
    }

    void OnNewAppointmentPatientSelected(AutoCompleteOption item)
    {
        if (item?.Value != null && Guid.TryParse(item.Value.ToString(), out var patientId))
        {
            newAppointment.FacilityPatientId = patientId;
        }
    }

    async Task OnNewAppointmentDoctorSearch(ChangeEventArgs e)
    {
        newAppointmentDoctorOptions = await SearchDoctors(e.Value?.ToString());
    }

    void OnNewAppointmentDoctorSelected(AutoCompleteOption item)
    {
        if (item?.Value != null && Guid.TryParse(item.Value.ToString(), out var doctorId))
        {
            newAppointment.FacilityDoctorId = doctorId;
        }
    }

    bool isAddAppointmentModalVisible = false;
    bool isAddAppointmentSaving = false;
    CreateFacilityAppointmentRequest newAppointment = new CreateFacilityAppointmentRequest();
    string? addAppointmentErrorMessage;

    // Update appointment modal and form-related fields
    bool isUpdateAppointmentModalVisible = false;
    bool isUpdateAppointmentSaving = false;
    Guid? selectedAppointmentId;
    UpdateAppointmentRequest updateAppointment = new UpdateAppointmentRequest();
    string? updateAppointmentTimeString;
    string? updateAppointmentErrorMessage;

    // Delete appointment modal and form-related fields
    bool isDeleteAppointmentSaving = false;
    bool isDeleteAppointmentModalVisible = false;
    Guid? appointmentIdToDelete;
    string? deleteAppointmentName;

    protected override async Task OnInitializedAsync()
    {
        LayoutState.OnAuthenticationChanged += OnAuthenticationChanged;
        LayoutState.ActiveTabKey = "appointment";
    }

    private async void OnAuthenticationChanged(bool isAuthenticated)
    {
        if (isAuthenticated && FacilityId != Guid.Empty)
        {
            await LayoutState.FetchFacilityAsync(ApiClient, FacilityId);
            StateHasChanged();
        }
    }

    async Task OnAppointmentTableChange(QueryModel<AppointmentResponse> query)
    {
        var response = await ApiClient.Api.V1.Facilities[FacilityId].Appointments.GetAsync(config =>
        {
            config.QueryParameters.Page = query.PageIndex;
            config.QueryParameters.PageSize = query.PageSize;
        });
        appointmentTableTotal = response?.Total ?? 0;
        appointmentTableDS = response?.Items ?? [];
    }

    private async Task<List<FacilityPatientResponse>> SearchPatients(string? keyword)
    {
        try
        {
            var patientResponse = await ApiClient.Api.V1.Facilities[FacilityId].Patients.Search.GetAsync(config =>
            {
                config.QueryParameters.Keyword = keyword;
                config.QueryParameters.Page = 1;
                config.QueryParameters.PageSize = 1000;
            });
            return patientResponse?.Items ?? [];
        }
        catch
        {
            return [];
        }
    }

    private async Task<List<FacilityStaffResponse>> SearchDoctors(string? keyword)
    {
        try
        {
            var staffResponse = await ApiClient.Api.V1.Facilities[FacilityId].Staff.Search.GetAsync(config =>
            {
                config.QueryParameters.Role = (int)UserRoleEnum.Doctor;
                config.QueryParameters.Keyword = keyword;
                config.QueryParameters.Page = 1;
                config.QueryParameters.PageSize = 1000;
            });
            return staffResponse?.Items ?? [];
        }
        catch
        {
            return [];
        }
    }

    void OpenAddAppointmentModal()
    {
        newAppointment = new CreateFacilityAppointmentRequest();
        newAppointmentDate = null;
        newAppointmentTimeString = null;
        addAppointmentErrorMessage = null;
        isAddAppointmentModalVisible = true;
    }

    void CloseAddAppointmentModal()
    {
        isAddAppointmentModalVisible = false;
        newAppointment = new CreateFacilityAppointmentRequest();
        newAppointmentDate = null;
        newAppointmentTimeString = null;
        addAppointmentErrorMessage = null;
    }

    async Task OnAddAppointmentSaveClick()
    {
        // Validation
        if (newAppointment.FacilityPatientId == Guid.Empty)
        {
            addAppointmentErrorMessage = "Patient is required.";
            return;
        }

        if (!newAppointmentDate.HasValue)
        {
            addAppointmentErrorMessage = "Appointment date is required.";
            return;
        }

        if (string.IsNullOrEmpty(newAppointmentTimeString))
        {
            addAppointmentErrorMessage = "Appointment time is required.";
            return;
        }

        try
        {
            isAddAppointmentSaving = true;
            addAppointmentErrorMessage = null;

            // Set the date and time from the separate pickers
            newAppointment.AppointmentDate = newAppointmentDate;
            newAppointment.AppointmentTime = newAppointmentTimeString;

            var response = await ApiClient.Api.V1.Facilities[FacilityId].Appointments.PostAsync(newAppointment);

            if (response != null)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Appointment added successfully!",
                    NotificationType = NotificationType.Success
                });

                isAddAppointmentModalVisible = false;
                newAppointment = new CreateFacilityAppointmentRequest();
                newAppointmentDate = null;
                newAppointmentTimeString = null;

                // Refresh the table by reloading initial data
                var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Appointments.GetAsync(config =>
                {
                    config.QueryParameters.Page = 1;
                    config.QueryParameters.PageSize = 10;
                });
                appointmentTableTotal = queryResponse?.Total ?? 0;
                appointmentTableDS = queryResponse?.Items ?? [];
            }
            else
            {
                addAppointmentErrorMessage = "Failed to add appointment. Please try again.";
            }
        }
        catch (Exception ex)
        {
            addAppointmentErrorMessage = $"Error adding appointment: {ex.Message}";
        }
        finally
        {
            isAddAppointmentSaving = false;
        }
    }

    async Task OpenUpdateAppointmentModal(AppointmentResponse appointment)
    {
        selectedAppointmentId = appointment.Id;
        updateAppointment = new UpdateAppointmentRequest
        {
            AppointmentDate = appointment.AppointmentDate,
            AppointmentTime = appointment.AppointmentTime,
            Status = appointment.Status,
            Reason = appointment.Reason
        };
        updateAppointmentTimeString = appointment.AppointmentTime;
        updateAppointmentErrorMessage = null;
        isUpdateAppointmentModalVisible = true;
    }

    void CloseUpdateAppointmentModal()
    {
        isUpdateAppointmentModalVisible = false;
        updateAppointment = new UpdateAppointmentRequest();
        updateAppointmentErrorMessage = null;
        selectedAppointmentId = null;
    }

    async Task OnUpdateAppointmentSaveClick()
    {
        try
        {
            isUpdateAppointmentSaving = true;
            updateAppointmentErrorMessage = null;

            if (selectedAppointmentId == null || selectedAppointmentId == Guid.Empty)
            {
                updateAppointmentErrorMessage = "No appointment selected.";
                return;
            }

            if (!string.IsNullOrEmpty(updateAppointmentTimeString))
            {
                updateAppointment.AppointmentTime = updateAppointmentTimeString;
            }

            // Create raw request for PUT operation since the API doesn't expose individual item endpoints
            var httpClient = new System.Net.Http.HttpClient();
            var url = $"/api/v1/facilities/{FacilityId}/appointments/{selectedAppointmentId}";
            var json = System.Text.Json.JsonSerializer.Serialize(updateAppointment);
            var content = new System.Net.Http.StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var putRequest = new System.Net.Http.HttpRequestMessage(System.Net.Http.HttpMethod.Put, url) { Content = content };

            // For now, skip the update until we have proper endpoint support
            updateAppointmentErrorMessage = "Update functionality coming soon. Please delete and recreate the appointment.";
            return;

            /*
            if (response != null)
            {
            await _notice.Open(new NotificationConfig()
            {
            Message = "Appointment updated successfully!",
            NotificationType = NotificationType.Success
            });

            isUpdateAppointmentModalVisible = false;
            updateAppointment = new UpdateAppointmentRequest();

            // Refresh the table by reloading initial data
            var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Appointments.GetAsync(config =>
            {
            config.QueryParameters.Page = 1;
            config.QueryParameters.PageSize = 10;
            });
            appointmentTableTotal = queryResponse?.Total ?? 0;
            appointmentTableDS = queryResponse?.Items ?? [];
            }
            else
            {
            updateAppointmentErrorMessage = "Failed to update appointment. Please try again.";
            }
            */
        }
        catch (Exception ex)
        {
            updateAppointmentErrorMessage = $"Error updating appointment: {ex.Message}";
        }
        finally
        {
            isUpdateAppointmentSaving = false;
        }
    }

    void OpenDeleteAppointmentModal(AppointmentResponse appointment)
    {
        appointmentIdToDelete = appointment.Id;
        deleteAppointmentName = $"{appointment.PatientName} - {appointment.AppointmentDate:yyyy-MM-dd}";
        isDeleteAppointmentModalVisible = true;
    }

    void CloseDeleteAppointmentModal()
    {
        isDeleteAppointmentModalVisible = false;
        appointmentIdToDelete = null;
        deleteAppointmentName = null;
    }

    async Task OnDeleteAppointmentConfirm()
    {
        try
        {
            isDeleteAppointmentSaving = true;

            if (appointmentIdToDelete == null || appointmentIdToDelete == Guid.Empty)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Error: No appointment selected for deletion.",
                    NotificationType = NotificationType.Error
                });
                return;
            }

            // For now, skip the delete until we have proper endpoint support
            await _notice.Open(new NotificationConfig()
            {
                Message = "Delete functionality coming soon.",
                NotificationType = NotificationType.Warning
            });
            return;

            /*
            await ApiClient.Api.V1.Facilities[FacilityId].Appointments[appointmentIdToDelete.Value].DeleteAsync();

            await _notice.Open(new NotificationConfig()
            {
            Message = "Appointment deleted successfully!",
            NotificationType = NotificationType.Success
            });

            appointmentIdToDelete = null;
            isDeleteAppointmentModalVisible = false;

            // Refresh the table by reloading initial data
            var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Appointments.GetAsync(config =>
            {
            config.QueryParameters.Page = 1;
            config.QueryParameters.PageSize = 10;
            });
            appointmentTableTotal = queryResponse?.Total ?? 0;
            appointmentTableDS = queryResponse?.Items ?? [];
            */
        }
        catch (Exception ex)
        {
            await _notice.Open(new NotificationConfig()
            {
                Message = $"Error deleting appointment: {ex.Message}",
                NotificationType = NotificationType.Error
            });
        }
        finally
        {
            isDeleteAppointmentSaving = false;
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        LayoutState.OnAuthenticationChanged -= OnAuthenticationChanged;
        await Task.CompletedTask;
    }
}