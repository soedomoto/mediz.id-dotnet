@page "/facilities/{FacilityId:guid}/staff"
@using System.Threading.Tasks
@using MedizID.UI.Services.Generated.Models
@layout FacilityLayout
@inject ILocalStorageService LocalStorage
@inject MedizIdApiClient ApiClient
@inject FacilityLayoutState LayoutState
@inject INotificationService _notice
@inject ModalService _modalService
@implements IAsyncDisposable

<PageTitle>@(LayoutState.Facility != null ? LayoutState.Facility.Name + " - Staff" : "MedizID")</PageTitle>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h2>Staff Members</h2>
    <Button Type="ButtonType.Primary" @onclick="OpenAddStaffModal">
        + Add Staff
    </Button>
</div>

<Table @ref="staffTable" TItem="FacilityStaffResponse" DataSource="staffTableDS" PageSize="10" Total="staffTableTotal"
    OnChange="OnStaffTableChange" ScrollX="1500">
    <ColumnDefinitions Context="row">
        <Column Title="Name" DataIndex="@nameof(FacilityStaffResponse.StaffName)" TData="string" />
        <Column Title="Role" TData="global::MedizID.UI.Services.Generated.Models.UserRoleEnum ?">
            @(GetUserRoleName(row?.Role))
        </Column>
        <Column Title="Specialization" DataIndex="@nameof(FacilityStaffResponse.Specialization)" TData="string" />
        <Column Title="Start Date" TData="FacilityStaffResponse">
            @(row?.StartDate?.ToString("yyyy-MM-dd") ?? "N/A")
        </Column>
        <Column Title="End Date" TData="FacilityStaffResponse">
            @(row?.EndDate?.ToString("yyyy-MM-dd") ?? "N/A")
        </Column>
        <Column Title="Active" DataIndex="@nameof(FacilityStaffResponse.IsActive)" TData="bool?" />
        <Column Title="Actions" TData="FacilityStaffResponse">
            <Space>
                <SpaceItem>
                    <Button Type="ButtonType.Primary" Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenUpdateStaffModal(row))">
                        Edit
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Danger Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenDeleteStaffModal(row))">
                        Delete
                    </Button>
                </SpaceItem>
            </Space>
        </Column>
    </ColumnDefinitions>
</Table>

<Modal Title="Add New Staff Member" Visible="isAddStaffModalVisible" OnOk="OnAddStaffSaveClick"
    OnCancel="CloseAddStaffModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(addStaffErrorMessage))
    {
        <Alert Message="Error" Description="@addStaffErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="newStaff" Layout="FormLayout.Vertical">
        <FormItem Label="Role" Required>
            <Select TItemValue="int?" TItem="int?" Placeholder="Select role" Value="@(newStaff.Role)"
                ValueChanged="@((int? value) => newStaff.Role = value)">
                <SelectOptions>
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.SuperAdmin)"
                        Label="SuperAdmin" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.FacilityOwner)"
                        Label="FacilityOwner" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Doctor)" Label="Doctor" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Midwife)"
                        Label="Midwife" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Nurse)" Label="Nurse" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Pharmacist)"
                        Label="Pharmacist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.LaboratoryTechnician)"
                        Label="LaboratoryTechnician" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Radiologist)"
                        Label="Radiologist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Physiotherapist)"
                        Label="Physiotherapist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Receptionist)"
                        Label="Receptionist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Patient)"
                        Label="Patient" />
                </SelectOptions>
            </Select>
        </FormItem>

        <FormItem Label="Specialization">
            <Input Value="newStaff.Specialization" ValueChanged="@((string value) => newStaff.Specialization = value)"
                Placeholder="Enter specialization" />
        </FormItem>

        <FormItem Label="Staff ID" Required>
            <AutoComplete @bind-Value="@newStaffKeyword" OnInput="OnNewStaffSearch" Options="@newStaffOptions"
                OnSelectionChange="@((AutoCompleteOption item) => OnNewStaffSelected(item))"
                Placeholder="Search staff by name or email" DebounceMilliseconds="300">
                <OptionTemplate Context="option">
                    <AutoCompleteOption Value="@option.Value.Id"
                        Label="@($"{option.Value.FirstName} {option.Value.LastName} ({option.Value.Email})")" />
                </OptionTemplate>
            </AutoComplete>
        </FormItem>
    </Form>
</Modal>

<Modal Title="Update Staff Member" Visible="isUpdateStaffModalVisible" OnOk="OnUpdateStaffSaveClick"
    OnCancel="CloseUpdateStaffModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(updateStaffErrorMessage))
    {
        <Alert Message="Error" Description="@updateStaffErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="updateStaff" Layout="FormLayout.Vertical">
        <FormItem Label="Role">
            <Select TItemValue="int?" TItem="int?" Placeholder="Select role" Value="@(updateStaff.Role)"
                ValueChanged="@((int? value) => updateStaff.Role = value)">
                <SelectOptions>
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.SuperAdmin)"
                        Label="Super Admin" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.FacilityOwner)"
                        Label="Facility Owner/Admin" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Doctor)" Label="Doctor" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Midwife)"
                        Label="Midwife" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Nurse)" Label="Nurse" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Pharmacist)"
                        Label="Pharmacist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.LaboratoryTechnician)"
                        Label="Laboratory Technician" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Radiologist)"
                        Label="Radiologist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Physiotherapist)"
                        Label="Physiotherapist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Receptionist)"
                        Label="Receptionist" />
                    <SelectOption TItemValue="int?" TItem="int?" Value="@((int?)UserRoleEnum.Patient)"
                        Label="Patient" />
                </SelectOptions>
            </Select>
        </FormItem>

        <FormItem Label="Specialization">
            <Input Value="@(updateStaff.Specialization ?? "")"
                ValueChanged="@((string value) => updateStaff.Specialization = value)"
                Placeholder="Enter specialization" />
        </FormItem>

        <FormItem Label="Active">
            <Checkbox Checked="@(updateStaff.IsActive ?? false)"
                CheckedChanged="@((bool value) => updateStaff.IsActive = value)" />
        </FormItem>
    </Form>
</Modal>

<Modal Title="Delete Staff Member" Visible="isDeleteStaffModalVisible" OnOk="OnDeleteStaffConfirm"
    OnCancel="CloseDeleteStaffModal" OkButtonProps="new ButtonProps { Danger = true }" OkText="@("Delete")"
    CancelText="@("Cancel")" BodyStyle="max-height: 60vh; overflow-y: auto;">
    <div>
        <p>Are you sure you want to delete this staff member assignment?</p>
        <p style="color: #ff4d4f; font-weight: bold;">This action cannot be undone.</p>
    </div>
</Modal>

@code {
    [Parameter]
    public Guid FacilityId { get; set; }

    // Table-related fields
    ITable? staffTable;
    List<FacilityStaffResponse> staffTableDS = [];
    int staffTableTotal = 0;

    // Add new staff modal and form-related fields
    string? newStaffKeyword;
    List<UserResponse> newStaffOptions = [];

    async Task OnNewStaffSearch(ChangeEventArgs e)
    {
        newStaffOptions = await SearchUserData(e.Value?.ToString());
    }

    void OnNewStaffSelected(AutoCompleteOption item)
    {
        if (item?.Value != null && Guid.TryParse(item.Value.ToString(), out var staffId))
        {
            newStaff.StaffId = staffId;
        }
    }
    bool isAddStaffModalVisible = false;
    bool isAddStaffSaving = false;
    AddStaffToFacilityRequest newStaff = new AddStaffToFacilityRequest();
    string? addStaffErrorMessage;

    // Update staff modal and form-related fields
    bool isUpdateStaffModalVisible = false;
    bool isUpdateStaffSaving = false;
    Guid? selectedStaffId;
    UpdateFacilityStaffRequest updateStaff = new UpdateFacilityStaffRequest();
    string? updateStaffErrorMessage;

    // Delete staff modal and form-related fields
    bool isDeleteStaffSaving = false;
    bool isDeleteStaffModalVisible = false;
    Guid? staffIdToDelete;
    string? deleteStaffName;

    protected override async Task OnInitializedAsync()
    {
        LayoutState.OnAuthenticationChanged += OnAuthenticationChanged;
        LayoutState.ActiveTabKey = "staff";
    }

    private async Task<List<UserResponse>> SearchUserData(string? keyword)
    {
        try
        {
            // Load available staff
            var staffResponse = await ApiClient.Api.V1.Users.Search.GetAsync(config =>
            {
                config.QueryParameters.Keyword = keyword;
                config.QueryParameters.Page = 1;
                config.QueryParameters.PageSize = 1000;
            });
            return staffResponse?.Items ?? [];

        }
        catch
        {
            return [];
        }
    }

    private async void OnAuthenticationChanged(bool isAuthenticated)
    {
        if (isAuthenticated && FacilityId != Guid.Empty)
        {
            await LayoutState.FetchFacilityAsync(ApiClient, FacilityId);
            StateHasChanged();
        }
    }

    async Task OnStaffTableChange(QueryModel<FacilityStaffResponse> query)
    {
        var response = await ApiClient.Api.V1.Facilities[FacilityId].Staff.GetAsync(config =>
        {
            config.QueryParameters.Page = query.PageIndex;
            config.QueryParameters.PageSize = query.PageSize;
        });
        staffTableTotal = response?.Total ?? 0;
        staffTableDS = response?.Items ?? [];
    }

    void OpenAddStaffModal()
    {
        newStaff = new AddStaffToFacilityRequest();
        addStaffErrorMessage = null;
        isAddStaffModalVisible = true;
    }

    void CloseAddStaffModal()
    {
        isAddStaffModalVisible = false;
        newStaff = new AddStaffToFacilityRequest();
        addStaffErrorMessage = null;
    }

    async Task OnAddStaffSaveClick()
    {
        // Validation
        if (!newStaff.Role.HasValue)
        {
            addStaffErrorMessage = "Role is required.";
            return;
        }

        if (!newStaff.StaffId.HasValue || newStaff.StaffId == Guid.Empty)
        {
            addStaffErrorMessage = "Staff is required.";
            return;
        }

        try
        {
            isAddStaffSaving = true;
            addStaffErrorMessage = null;

            var response = await ApiClient.Api.V1.Facilities[FacilityId].Staff.PostAsync(newStaff);

            if (response != null)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Staff added successfully!",
                    NotificationType = NotificationType.Success
                });

                isAddStaffModalVisible = false;
                newStaff = new AddStaffToFacilityRequest();

                // Refresh the table by reloading initial data
                var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Staff.GetAsync(config =>
                {
                    config.QueryParameters.Page = 1;
                    config.QueryParameters.PageSize = 10;
                });
                staffTableTotal = queryResponse?.Total ?? 0;
                staffTableDS = queryResponse?.Items ?? [];
            }
            else
            {
                addStaffErrorMessage = "Failed to add staff. Please try again.";
            }
        }
        catch (Exception ex)
        {
            addStaffErrorMessage = $"Error adding staff: {ex.Message}";
        }
        finally
        {
            isAddStaffSaving = false;
        }
    }

    async Task OpenUpdateStaffModal(FacilityStaffResponse staff)
    {
        selectedStaffId = staff.Id;
        updateStaff = new UpdateFacilityStaffRequest
        {
            Role = staff.Role,
            Specialization = staff.Specialization,
            IsActive = staff.IsActive
        };
        updateStaffErrorMessage = null;
        isUpdateStaffModalVisible = true;
    }

    void CloseUpdateStaffModal()
    {
        isUpdateStaffModalVisible = false;
        updateStaff = new UpdateFacilityStaffRequest();
        updateStaffErrorMessage = null;
        selectedStaffId = null;
    }

    async Task OnUpdateStaffSaveClick()
    {
        try
        {
            isUpdateStaffSaving = true;
            updateStaffErrorMessage = null;

            if (selectedStaffId == null || selectedStaffId == Guid.Empty)
            {
                updateStaffErrorMessage = "No staff selected.";
                return;
            }

            var response = await ApiClient.Api.V1.Facilities[FacilityId].Staff[selectedStaffId.Value].PutAsync(updateStaff);

            if (response != null)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Staff updated successfully!",
                    NotificationType = NotificationType.Success
                });

                isUpdateStaffModalVisible = false;
                updateStaff = new UpdateFacilityStaffRequest();

                // Refresh the table by reloading initial data
                var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Staff.GetAsync(config =>
                {
                    config.QueryParameters.Page = 1;
                    config.QueryParameters.PageSize = 10;
                });
                staffTableTotal = queryResponse?.Total ?? 0;
                staffTableDS = queryResponse?.Items ?? [];
            }
            else
            {
                updateStaffErrorMessage = "Failed to update staff. Please try again.";
            }
        }
        catch (Exception ex)
        {
            updateStaffErrorMessage = $"Error updating staff: {ex.Message}";
        }
        finally
        {
            isUpdateStaffSaving = false;
        }
    }

    void OpenDeleteStaffModal(FacilityStaffResponse staff)
    {
        staffIdToDelete = staff.Id;
        deleteStaffName = staff.Role.ToString();
        isDeleteStaffModalVisible = true;
    }

    void CloseDeleteStaffModal()
    {
        isDeleteStaffModalVisible = false;
        staffIdToDelete = null;
        deleteStaffName = null;
    }

    async Task OnDeleteStaffConfirm()
    {
        try
        {
            isDeleteStaffSaving = true;

            if (staffIdToDelete == null || staffIdToDelete == Guid.Empty)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Error: No staff selected for deletion.",
                    NotificationType = NotificationType.Error
                });
                return;
            }

            await ApiClient.Api.V1.Facilities[FacilityId].Staff[staffIdToDelete.Value].DeleteAsync();

            await _notice.Open(new NotificationConfig()
            {
                Message = "Staff deleted successfully!",
                NotificationType = NotificationType.Success
            });

            staffIdToDelete = null;
            isDeleteStaffModalVisible = false;

            // Refresh the table by reloading initial data
            var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Staff.GetAsync(config =>
            {
                config.QueryParameters.Page = 1;
                config.QueryParameters.PageSize = 10;
            });
            staffTableTotal = queryResponse?.Total ?? 0;
            staffTableDS = queryResponse?.Items ?? [];
        }
        catch (Exception ex)
        {
            await _notice.Open(new NotificationConfig()
            {
                Message = $"Error deleting staff: {ex.Message}",
                NotificationType = NotificationType.Error
            });
        }
        finally
        {
            isDeleteStaffSaving = false;
        }
    }

    private string GetUserRoleName(int? type)
    {
        return type switch
        {
            (int?)UserRoleEnum.SuperAdmin => "Super Admin",
            (int?)UserRoleEnum.FacilityOwner => "Facility Owner/Admin",
            (int?)UserRoleEnum.Doctor => "Doctor",
            (int?)UserRoleEnum.Midwife => "Midwife",
            (int?)UserRoleEnum.Nurse => "Nurse",
            (int?)UserRoleEnum.Pharmacist => "Pharmacist",
            (int?)UserRoleEnum.LaboratoryTechnician => "Laboratory Technician",
            (int?)UserRoleEnum.Radiologist => "Radiologist",
            (int?)UserRoleEnum.Physiotherapist => "Physiotherapist",
            (int?)UserRoleEnum.Receptionist => "Receptionist",
            (int?)UserRoleEnum.Patient => "Patient",
            _ => "Unknown"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        LayoutState.OnAuthenticationChanged -= OnAuthenticationChanged;
        await Task.CompletedTask;
    }
}