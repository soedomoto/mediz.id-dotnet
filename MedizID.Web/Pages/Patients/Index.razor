@page "/patients"
@using MedizID.Web.Services
@using MedizID.Web.Models
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject IAuthenticationService AuthService

<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Patients</h1>
                <a href="/patients/create" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
                    + New Patient
                </a>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        @if (isLoading)
        {
            <div class="bg-white rounded-lg shadow p-8 text-center">
                <p class="text-gray-600">Loading patients...</p>
            </div>
        }
        else if (patients.Count == 0)
        {
            <div class="bg-white rounded-lg shadow p-8 text-center">
                <p class="text-gray-600 mb-4">No patients found</p>
                <a href="/patients/create" class="text-blue-600 hover:underline">Create the first patient</a>
            </div>
        }
        else
        {
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">MRN</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Name</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Email</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Phone</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Age</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @foreach (var patient in patients)
                        {
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">@patient.MRN</td>
                                <td class="px-6 py-4 text-sm text-gray-700">@patient.FullName</td>
                                <td class="px-6 py-4 text-sm text-gray-700">@patient.Email</td>
                                <td class="px-6 py-4 text-sm text-gray-700">@patient.PhoneNumber</td>
                                <td class="px-6 py-4 text-sm text-gray-700">@patient.Age</td>
                                <td class="px-6 py-4 text-sm">
                                    <a href="@($"/patients/{patient.Id}")" class="text-blue-600 hover:underline mr-2">View</a>
                                    <a href="@($"/patients/{patient.Id}/edit")" class="text-green-600 hover:underline">Edit</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<PatientModel> patients = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadPatients();
    }

    private async Task LoadPatients()
    {
        isLoading = true;
        try
        {
            patients = await ApiService.GetListAsync<PatientModel>("/api/v1/patients");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading patients: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
