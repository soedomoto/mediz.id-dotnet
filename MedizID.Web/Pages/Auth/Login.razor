@page "/login"
@layout UnauthenticatedLayout
@inject MedizIdApiClient ApiClient
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavigationManager

<div class="login-container">
    <Card Title="Login to MedizID" Style="width: 100%; max-width: 400px;">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <Alert Message="Error" Description="@errorMessage" Type="AlertType.Error" ShowIcon="true" Style="margin-bottom: 16px;" />
        }

        <Form Model="loginRequest" Layout="FormLayout.Vertical" OnFinish="OnFinish">
            <FormItem Label="Email Address">
                <Input @bind-Value="loginRequest.Email" Type="InputType.Email" Placeholder="Enter your email" />
            </FormItem>

            <FormItem Label="Password">
                <InputPassword @bind-Value="loginRequest.Password" Placeholder="Enter your password" />
            </FormItem>

            <FormItem>
                <Button HtmlType="submit" Type="ButtonType.Primary" Loading="isLoading" Block>
                    @if (isLoading)
                    {
                        <span>Logging in...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </Button>
            </FormItem>
        </Form>

        <div style="text-align: center; margin-top: 16px;">
            <p>Don't have an account? <a href="/register">Register here</a></p>
        </div>
    </Card>
</div>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 64px - 69px);
        padding: 24px;
    }
</style>

@code {
    private LoginRequest loginRequest = new LoginRequest();
    private string? errorMessage;
    private bool isLoading = false;
    private bool showError = true;

    private async void OnFinish(EditContext editContext)
    {
        if (string.IsNullOrWhiteSpace(loginRequest.Email) || string.IsNullOrWhiteSpace(loginRequest.Password))
        {
            errorMessage = "Please enter both email and password.";
            showError = true;
            return;
        }

        try
        {
            isLoading = true;
            errorMessage = null;
            showError = false;

            var response = await ApiClient.Api.V1.Auth.Login.PostAsync(loginRequest);

            if (response != null)
            {
                // Store token in local storage
                await LocalStorage.SetItemAsync("user", response);

                // Navigate to home page
                NavigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = "Login failed. Please try again.";
                showError = true;
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            errorMessage = "Invalid email or password. Please try again.";
            showError = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error during login: {ex.Message}";
            showError = true;
        }
        finally
        {
            isLoading = false;
        }
    }
}

