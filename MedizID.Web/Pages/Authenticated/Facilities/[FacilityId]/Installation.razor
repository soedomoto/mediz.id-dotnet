@page "/facilities/{FacilityId:guid}/installation"
@using System.Threading.Tasks
@using MedizID.Web.Services.Generated.Models
@layout FacilityLayout
@inject ILocalStorageService LocalStorage
@inject MedizIdApiClient ApiClient
@inject FacilityLayoutState LayoutState
@inject INotificationService _notice
@inject ModalService _modalService
@implements IAsyncDisposable

<PageTitle>@(LayoutState.Facility != null ? LayoutState.Facility.Name + " - Installation" : "MedizID")</PageTitle>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
    <h2>Installations</h2>
    <Button Type="ButtonType.Primary" @onclick="OpenAddInstallationModal">
        + Add Installation
    </Button>
</div>

<Table @ref="installationTable" TItem="InstallationResponse" DataSource="installationTableDS" PageSize="10"
    Total="installationTableTotal" OnChange="OnInstallationTableChange" ScrollX="1500">
    <ColumnDefinitions Context="row">
        <Column Title="Name" DataIndex="@nameof(InstallationResponse.Name)" TData="string" />
        <Column Title="Type" TData="InstallationResponse">
            @(GetInstallationTypeName(row?.Type ?? 0))
        </Column>
        <Column Title="Location" DataIndex="@nameof(InstallationResponse.Location)" TData="string" />
        <Column Title="Condition" DataIndex="@nameof(InstallationResponse.Condition)" TData="string" />
        <Column Title="Last Maintenance" TData="InstallationResponse">
            @(row?.LastMaintenanceDate?.ToString("yyyy-MM-dd") ?? "N/A")
        </Column>
        <Column Title="Active" DataIndex="@nameof(InstallationResponse.IsActive)" TData="bool?" />
        <Column Title="Actions" TData="InstallationResponse">
            <Space>
                <SpaceItem>
                    <Button Type="ButtonType.Primary" Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenUpdateInstallationModal(row))">
                        Edit
                    </Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Danger Size="ButtonSize.Small"
                        @onclick="@((MouseEventArgs e) => OpenDeleteInstallationModal(row))">
                        Delete
                    </Button>
                </SpaceItem>
            </Space>
        </Column>
    </ColumnDefinitions>
</Table>

<Modal Title="Add New Installation" Visible="isAddInstallationModalVisible" OnOk="OnAddInstallationSaveClick"
    OnCancel="CloseAddInstallationModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(addInstallationErrorMessage))
    {
        <Alert Message="Error" Description="@addInstallationErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="newInstallation" Layout="FormLayout.Vertical">
        <FormItem Label="Name" Required>
            <Input Value="newInstallation.Name" ValueChanged="@((string value) => newInstallation.Name = value)"
                Placeholder="Enter installation name" />
        </FormItem>

        <FormItem Label="Type" Required>
            <Select TItemValue="int" TItem="int" 
                Placeholder="Select installation type"
                Value="@(newInstallation.Type ?? 0)"
                ValueChanged="@((int value) => newInstallation.Type = value)">
                <SelectOptions>
                    <SelectOption TItemValue="int" TItem="int" Value="0"
                        Label="Emergency" />
                    <SelectOption TItemValue="int" TItem="int" Value="1"
                        Label="Outpatient" />
                    <SelectOption TItemValue="int" TItem="int" Value="2"
                        Label="Inpatient" />
                    <SelectOption TItemValue="int" TItem="int" Value="3"
                        Label="Pharmacy" />
                    <SelectOption TItemValue="int" TItem="int" Value="4"
                        Label="Laboratory" />
                    <SelectOption TItemValue="int" TItem="int" Value="5"
                        Label="Radiology" />
                </SelectOptions>
            </Select>
        </FormItem>

        <FormItem Label="Location" Required>
            <Input Value="newInstallation.Location" ValueChanged="@((string value) => newInstallation.Location = value)"
                Placeholder="Enter location" />
        </FormItem>

        <FormItem Label="Condition" Required>
            <Input Value="newInstallation.Condition" ValueChanged="@((string value) => newInstallation.Condition = value)"
                Placeholder="Enter condition" />
        </FormItem>

        <FormItem Label="Last Maintenance Date">
            <Input @bind-Value="lastMaintenanceDateAdd" Type="InputType.Date" Placeholder="Select date" />
        </FormItem>

        <FormItem Label="Active">
            <Checkbox Checked="@(newInstallation.IsActive ?? false)"
                CheckedChanged="@((bool value) => newInstallation.IsActive = value)" />
        </FormItem>


    </Form>
</Modal>

<Modal Title="Update Installation" Visible="isUpdateInstallationModalVisible" OnOk="OnUpdateInstallationSaveClick"
    OnCancel="CloseUpdateInstallationModal" BodyStyle="max-height: 60vh; overflow-y: auto;">
    @if (!string.IsNullOrEmpty(updateInstallationErrorMessage))
    {
        <Alert Message="Error" Description="@updateInstallationErrorMessage" Type="AlertType.Error" ShowIcon="true"
            Style="margin-bottom: 16px;" />
    }

    <Form Model="updateInstallation" Layout="FormLayout.Vertical">
        <FormItem Label="Name" Required>
            <Input Value="@(updateInstallation.Name ?? "")" ValueChanged="@((string value) => updateInstallation.Name = value)"
                Placeholder="Enter installation name" />
        </FormItem>

        <FormItem Label="Type" Required>
            <Select TItemValue="int" TItem="int" 
                Placeholder="Select installation type"
                Value="@(updateInstallation.Type ?? 0)"
                ValueChanged="@((int value) => updateInstallation.Type = value)">
                <SelectOptions>
                    <SelectOption TItemValue="int" TItem="int" Value="0"
                        Label="Emergency" />
                    <SelectOption TItemValue="int" TItem="int" Value="1"
                        Label="Outpatient" />
                    <SelectOption TItemValue="int" TItem="int" Value="2"
                        Label="Inpatient" />
                    <SelectOption TItemValue="int" TItem="int" Value="3"
                        Label="Pharmacy" />
                    <SelectOption TItemValue="int" TItem="int" Value="4"
                        Label="Laboratory" />
                    <SelectOption TItemValue="int" TItem="int" Value="5"
                        Label="Radiology" />
                </SelectOptions>
            </Select>
        </FormItem>

        <FormItem Label="Location" Required>
            <Input Value="@(updateInstallation.Location ?? "")"
                ValueChanged="@((string value) => updateInstallation.Location = value)"
                Placeholder="Enter location" />
        </FormItem>

        <FormItem Label="Condition" Required>
            <Input Value="@(updateInstallation.Condition ?? "")"
                ValueChanged="@((string value) => updateInstallation.Condition = value)" Placeholder="Enter condition" />
        </FormItem>

        <FormItem Label="Last Maintenance Date">
            <Input @bind-Value="lastMaintenanceDateUpdate" Type="InputType.Date" Placeholder="Select date" />
        </FormItem>

        <FormItem Label="Active">
            <Checkbox Checked="@(updateInstallation.IsActive ?? false)"
                CheckedChanged="@((bool value) => updateInstallation.IsActive = value)" />
        </FormItem>

        <FormItem Label="Last Maintenance Date">
            <Input @bind-Value="lastMaintenanceDateUpdate" Type="InputType.Date" Placeholder="Select date" />
        </FormItem>

        <FormItem Label="Active">
            <Checkbox Checked="@(updateInstallation.IsActive ?? false)"
                CheckedChanged="@((bool value) => updateInstallation.IsActive = value)" />
        </FormItem>
    </Form>
</Modal>

<Modal Title="Delete Installation" Visible="isDeleteInstallationModalVisible" OnOk="OnDeleteInstallationConfirm"
    OnCancel="CloseDeleteInstallationModal" OkButtonProps="new ButtonProps { Danger = true }" OkText="@("Delete")"
    CancelText="@("Cancel")" BodyStyle="max-height: 60vh; overflow-y: auto;">
    <div>
        <p>Are you sure you want to delete the installation <strong>@deleteInstallationName</strong>?</p>
        <p style="color: #ff4d4f; font-weight: bold;">This action cannot be undone.</p>
    </div>
</Modal>

@code {
    [Parameter]
    public Guid FacilityId { get; set; }
    
    // Table-related fields
    ITable? installationTable;
    List<InstallationResponse> installationTableDS = [];
    int installationTableTotal = 0;
    
    // Add new installation modal and form-related fields
    bool isAddInstallationModalVisible = false;
    bool isAddInstallationSaving = false;
    CreateInstallationRequest newInstallation = new CreateInstallationRequest();
    string? addInstallationErrorMessage;
    string? lastMaintenanceDateAdd;
    
    // Update installation modal and form-related fields
    bool isUpdateInstallationModalVisible = false;
    bool isUpdateInstallationSaving = false;
    Guid? selectedInstallationId;
    UpdateInstallationRequest updateInstallation = new UpdateInstallationRequest();
    string? updateInstallationErrorMessage;
    string? lastMaintenanceDateUpdate;
    
    // Delete installation modal and form-related fields
    bool isDeleteInstallationSaving = false;
    bool isDeleteInstallationModalVisible = false;
    Guid? installationIdToDelete;
    string? deleteInstallationName;

    protected override async Task OnInitializedAsync()
    {
        LayoutState.OnAuthenticationChanged += OnAuthenticationChanged;
        LayoutState.ActiveTabKey = "installation";
    }

    private async void OnAuthenticationChanged(bool isAuthenticated)
    {
        if (isAuthenticated && FacilityId != Guid.Empty)
        {
            await LayoutState.FetchFacilityAsync(ApiClient, FacilityId);
            StateHasChanged();
        }
    }

    async Task OnInstallationTableChange(QueryModel<InstallationResponse> query)
    {
        var response = await ApiClient.Api.V1.Facilities[FacilityId].Installations.GetAsync(config => 
        {
            config.QueryParameters.Page = query.PageIndex;
            config.QueryParameters.PageSize = query.PageSize;
        });
        installationTableTotal = response?.Total ?? 0;
        installationTableDS = response?.Items ?? [];
    }

    void OpenAddInstallationModal()
    {
        newInstallation = new CreateInstallationRequest();
        addInstallationErrorMessage = null;
        lastMaintenanceDateAdd = null;
        isAddInstallationModalVisible = true;
    }

    void CloseAddInstallationModal()
    {
        isAddInstallationModalVisible = false;
        newInstallation = new CreateInstallationRequest();
        addInstallationErrorMessage = null;
        lastMaintenanceDateAdd = null;
    }

    async Task OnAddInstallationSaveClick()
    {
        // Validation
        if (string.IsNullOrWhiteSpace(newInstallation.Name))
        {
            addInstallationErrorMessage = "Installation name is required.";
            return;
        }

        if (!newInstallation.Type.HasValue || newInstallation.Type <= 0)
        {
            addInstallationErrorMessage = "Type is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(newInstallation.Location))
        {
            addInstallationErrorMessage = "Location is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(newInstallation.Condition))
        {
            addInstallationErrorMessage = "Condition is required.";
            return;
        }

        try
        {
            isAddInstallationSaving = true;
            addInstallationErrorMessage = null;

            // Convert date string to DateTimeOffset
            if (!string.IsNullOrWhiteSpace(lastMaintenanceDateAdd) && DateTime.TryParse(lastMaintenanceDateAdd, out var maintenanceDate))
            {
                newInstallation.LastMaintenanceDate = new DateTimeOffset(maintenanceDate);
            }

            var response = await ApiClient.Api.V1.Facilities[FacilityId].Installations.PostAsync(newInstallation);

            if (response != null)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Installation created successfully!",
                    NotificationType = NotificationType.Success
                });

                isAddInstallationModalVisible = false;
                newInstallation = new CreateInstallationRequest();

                // Refresh the table by reloading initial data
                var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Installations.GetAsync(config =>
                {
                    config.QueryParameters.Page = 1;
                    config.QueryParameters.PageSize = 10;
                });
                installationTableTotal = queryResponse?.Total ?? 0;
                installationTableDS = queryResponse?.Items ?? [];
            }
            else
            {
                addInstallationErrorMessage = "Failed to create installation. Please try again.";
            }
        }
        catch (Exception ex)
        {
            addInstallationErrorMessage = $"Error creating installation: {ex.Message}";
        }
        finally
        {
            isAddInstallationSaving = false;
        }
    }

    async Task OpenUpdateInstallationModal(InstallationResponse installation)
    {
        selectedInstallationId = installation.Id;
        updateInstallation = new UpdateInstallationRequest
        {
            Name = installation.Name,
            Type = installation.Type,
            Location = installation.Location,
            Condition = installation.Condition,
            LastMaintenanceDate = installation.LastMaintenanceDate,
            IsActive = installation.IsActive
        };
        lastMaintenanceDateUpdate = installation.LastMaintenanceDate?.ToString("yyyy-MM-dd");
        updateInstallationErrorMessage = null;
        isUpdateInstallationModalVisible = true;
    }

    void CloseUpdateInstallationModal()
    {
        isUpdateInstallationModalVisible = false;
        updateInstallation = new UpdateInstallationRequest();
        updateInstallationErrorMessage = null;
        lastMaintenanceDateUpdate = null;
        selectedInstallationId = null;
    }

    async Task OnUpdateInstallationSaveClick()
    {
        // Validation
        if (string.IsNullOrWhiteSpace(updateInstallation.Name))
        {
            updateInstallationErrorMessage = "Installation name is required.";
            return;
        }

        if (!updateInstallation.Type.HasValue || updateInstallation.Type < 0)
        {
            updateInstallationErrorMessage = "Type is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(updateInstallation.Location))
        {
            updateInstallationErrorMessage = "Location is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(updateInstallation.Condition))
        {
            updateInstallationErrorMessage = "Condition is required.";
            return;
        }

        try
        {
            isUpdateInstallationSaving = true;
            updateInstallationErrorMessage = null;

            if (selectedInstallationId == null || selectedInstallationId == Guid.Empty)
            {
                updateInstallationErrorMessage = "No installation selected.";
                return;
            }

            // Convert date string to DateTimeOffset
            if (!string.IsNullOrWhiteSpace(lastMaintenanceDateUpdate) && DateTime.TryParse(lastMaintenanceDateUpdate, out var maintenanceDate))
            {
                updateInstallation.LastMaintenanceDate = new DateTimeOffset(maintenanceDate);
            }

            var response = await ApiClient.Api.V1.Facilities[FacilityId].Installations[selectedInstallationId.Value].PutAsync(updateInstallation);

            if (response != null)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Installation updated successfully!",
                    NotificationType = NotificationType.Success
                });

                isUpdateInstallationModalVisible = false;
                updateInstallation = new UpdateInstallationRequest();

                // Refresh the table by reloading initial data
                var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Installations.GetAsync(config =>
                {
                    config.QueryParameters.Page = 1;
                    config.QueryParameters.PageSize = 10;
                });
                installationTableTotal = queryResponse?.Total ?? 0;
                installationTableDS = queryResponse?.Items ?? [];
            }
            else
            {
                updateInstallationErrorMessage = "Failed to update installation. Please try again.";
            }
        }
        catch (Exception ex)
        {
            updateInstallationErrorMessage = $"Error updating installation: {ex.Message}";
        }
        finally
        {
            isUpdateInstallationSaving = false;
        }
    }

    void OpenDeleteInstallationModal(InstallationResponse installation)
    {
        installationIdToDelete = installation.Id;
        deleteInstallationName = installation.Name;
        isDeleteInstallationModalVisible = true;
    }

    void CloseDeleteInstallationModal()
    {
        isDeleteInstallationModalVisible = false;
        installationIdToDelete = null;
        deleteInstallationName = null;
    }

    async Task OnDeleteInstallationConfirm()
    {
        try
        {
            isDeleteInstallationSaving = true;

            if (installationIdToDelete == null || installationIdToDelete == Guid.Empty)
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Error: No installation selected for deletion.",
                    NotificationType = NotificationType.Error
                });
                return;
            }

            await ApiClient.Api.V1.Facilities[FacilityId].Installations[installationIdToDelete.Value].DeleteAsync();

            await _notice.Open(new NotificationConfig()
            {
                Message = "Installation deleted successfully!",
                NotificationType = NotificationType.Success
            });

            installationIdToDelete = null;
            isDeleteInstallationModalVisible = false;

            // Refresh the table by reloading initial data
            var queryResponse = await ApiClient.Api.V1.Facilities[FacilityId].Installations.GetAsync(config =>
            {
                config.QueryParameters.Page = 1;
                config.QueryParameters.PageSize = 10;
            });
            installationTableTotal = queryResponse?.Total ?? 0;
            installationTableDS = queryResponse?.Items ?? [];
        }
        catch (Exception ex)
        {
            await _notice.Open(new NotificationConfig()
            {
                Message = $"Error deleting installation: {ex.Message}",
                NotificationType = NotificationType.Error
            });
        }
        finally
        {
            isDeleteInstallationSaving = false;
        }
    }

    private string GetInstallationTypeName(int type)
    {
        return type switch
        {
            0 => "Emergency",
            1 => "Outpatient",
            2 => "Inpatient",
            3 => "Pharmacy",
            4 => "Laboratory",
            5 => "Radiology",
            _ => "Unknown"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        LayoutState.OnAuthenticationChanged -= OnAuthenticationChanged;
        await Task.CompletedTask;
    }
}