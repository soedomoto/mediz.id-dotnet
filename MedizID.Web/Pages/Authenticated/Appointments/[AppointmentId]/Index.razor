@page "/appointments/{AppointmentId:guid}"
@layout AppointmentLayout
@using System.Threading.Tasks
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using MedizID.Web.Services.Generated.Models
@inject ILocalStorageService LocalStorage
@inject MedizIdApiClient ApiClient
@inject AppointmentLayoutState LayoutState
@inject INotificationService _notice
@implements IAsyncDisposable

<PageTitle>@(LayoutState.Appointment != null ? LayoutState.Appointment.PatientName + " - MedizID" : "MedizID")</PageTitle>

<div style="padding: 24px; background-color: white; border-radius: 8px;">
    @if (LayoutState.Appointment != null)
    {
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            @if (isSaving)
            {
                <span style="color: #1890ff;">Saving...</span>
            }
        </div>

        <Form Layout="@FormLayout.Vertical" Model="formModel" OnFinish="HandleSave">
            <FormItem Label="Patient Name">
                <Input @bind-Value="LayoutState.Appointment.PatientName" Disabled />
            </FormItem>

            <FormItem Label="Patient ID Number">
                <Input @bind-Value="LayoutState.Appointment.PatientIdNumber" Disabled />
            </FormItem>

            <FormItem Label="Doctor Name">
                <Input @bind-Value="LayoutState.Appointment.DoctorName" Disabled />
            </FormItem>

            <FormItem Label="Appointment Date" Required>
                <DatePicker @bind-Value="appointmentDate" />
            </FormItem>

            <FormItem Label="Appointment Time" Required>
                <Input @bind-Value="appointmentTime" Placeholder="HH:mm:ss" />
            </FormItem>

            <FormItem Label="Status" Required>
                <Select @bind-Value="appointmentStatus" 
                        TItemValue="string"
                        TItem="string"
                        Placeholder="Select status"
                        OptionFilterMode="OptionFilterMode.OptionLabelPropFilter"
                        AllowClear>
                    <SelectOption TItemValue="string" TItem="string" Value="@("Scheduled")" Label="Scheduled" />
                    <SelectOption TItemValue="string" TItem="string" Value="@("Completed")" Label="Completed" />
                    <SelectOption TItemValue="string" TItem="string" Value="@("Cancelled")" Label="Cancelled" />
                    <SelectOption TItemValue="string" TItem="string" Value="@("NoShow")" Label="No Show" />
                </Select>
            </FormItem>

            <FormItem Label="Reason">
                <TextArea @bind-Value="appointmentReason" Rows="3" Placeholder="Enter appointment reason" />
            </FormItem>

            <FormItem Label="Notes">
                <TextArea @bind-Value="appointmentNotes" Rows="3" Placeholder="Enter additional notes" />
            </FormItem>

            <FormItem Label="Created Date">
                <Input @bind-Value="createdAtDisplay" Disabled />
            </FormItem>

            <FormItem>
                <Space>
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary" HtmlType="submit" Loading="isSaving">
                            Save Changes
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button @onclick="HandleCancel">
                            Cancel
                        </Button>
                    </SpaceItem>
                </Space>
            </FormItem>
        </Form>
    }
    else
    {
        <div style="text-align: center; padding: 48px 0;">
            <p>Loading appointment details...</p>
        </div>
    }
</div>

@code {
    [Parameter]
    public Guid AppointmentId { get; set; }

    private bool isSaving = false;
    private DateTime? appointmentDate;
    private string? appointmentTime;
    private string? appointmentStatus;
    private string? appointmentReason;
    private string? appointmentNotes;
    private string? createdAtDisplay;
    private object formModel = new();

    protected override async Task OnInitializedAsync()
    {
        LayoutState.OnAuthenticationChanged += OnAuthenticationChanged;
        LayoutState.ActiveTabKey = "";
    }

    private async void OnAuthenticationChanged(bool isAuthenticated)
    {
        if (isAuthenticated && AppointmentId != Guid.Empty)
        {
            await LayoutState.FetchAppointmentAsync(ApiClient, AppointmentId);
            InitializeFormFromAppointment();
            StateHasChanged();
        }
    }

    protected override Task OnParametersSetAsync()
    {
        if (LayoutState.Appointment != null)
        {
            InitializeFormFromAppointment();
        }
        return Task.CompletedTask;
    }

    private void InitializeFormFromAppointment()
    {
        if (LayoutState.Appointment == null)
            return;

        appointmentDate = LayoutState.Appointment.AppointmentDate?.DateTime;
        appointmentTime = LayoutState.Appointment.AppointmentTime;
        appointmentStatus = LayoutState.Appointment.Status;
        appointmentReason = LayoutState.Appointment.Reason;
        appointmentNotes = LayoutState.Appointment.Notes;
        createdAtDisplay = LayoutState.Appointment.CreatedAt?.ToString("yyyy-MM-dd HH:mm:ss");
    }

    private async Task HandleSave(EditContext context)
    {
        try
        {
            isSaving = true;

            // Validate time format
            if (string.IsNullOrWhiteSpace(appointmentTime) || !TimeSpan.TryParse(appointmentTime, out var timeSpan))
            {
                await _notice.Open(new NotificationConfig()
                {
                    Message = "Please enter a valid time in HH:mm:ss format",
                    NotificationType = NotificationType.Error
                });
                isSaving = false;
                return;
            }

            var updateRequest = new UpdateAppointmentRequest
            {
                AppointmentDate = appointmentDate,
                AppointmentTime = appointmentTime,
                Status = appointmentStatus,
                Reason = appointmentReason,
                Notes = appointmentNotes
            };

            // Call the update endpoint
            var response = await ApiClient.Api.V1.Appointments[AppointmentId].PutAsync(updateRequest);

            if (response != null)
            {
                // Update the layout state with the response
                LayoutState.Appointment = new AppointmentDetailResponse
                {
                    Id = response.Id,
                    PatientName = response.PatientName,
                    // PatientIdNumber property does not exist in AppointmentResponse, removing this line
                    DoctorName = response.DoctorName,
                    AppointmentDate = response.AppointmentDate,
                    AppointmentTime = response.AppointmentTime,
                    Status = response.Status,
                    Reason = response.Reason,
                    // Notes property does not exist in AppointmentResponse, removing this line
                    CreatedAt = response.CreatedAt
                };
                InitializeFormFromAppointment();

                await _notice.Open(new NotificationConfig()
                {
                    Message = "Appointment updated successfully",
                    NotificationType = NotificationType.Success
                });
            }
        }
        catch (Exception ex)
        {
            await _notice.Open(new NotificationConfig()
            {
                Message = $"Error saving appointment: {ex.Message}",
                NotificationType = NotificationType.Error
            });
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleCancel()
    {
        // Reload the appointment to discard changes
        if (AppointmentId != Guid.Empty)
        {
            await LayoutState.FetchAppointmentAsync(ApiClient, AppointmentId);
            InitializeFormFromAppointment();
            
            await _notice.Open(new NotificationConfig()
            {
                Message = "Changes cancelled",
                NotificationType = NotificationType.Info
            });
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        LayoutState.OnAuthenticationChanged -= OnAuthenticationChanged;
        await Task.CompletedTask;
    }
}