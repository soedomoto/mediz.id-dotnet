# This workflow has been consolidated into deploy.yml
# Please use deploy.yml for combined API and Web deployment

name: Build and Deploy MedizID.Web (Deprecated)

on:
  push:
    branches:
      - mainx
    paths:
      - 'MedizID.Web/**'
      - 'MedizID.sln'
      - '.github/workflows/deploy-web.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore MedizID.sln

      - name: Build MedizID.Web
        run: dotnet build MedizID.Web/MedizID.Web.csproj -c Release --no-restore

      - name: Run tests
        run: dotnet test MedizID.sln -c Release --no-build --verbosity normal
        continue-on-error: true

      - name: Publish MedizID.Web
        run: dotnet publish MedizID.Web/MedizID.Web.csproj -c Release -o ./publish

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: medizid-web-release
          path: ./publish
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: medizid-web-release
          path: ./publish

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "mkdir -p ~/medizid-web && sudo systemctl stop medizid-web || true && sleep 2"
          scp -r -i ~/.ssh/deploy_key ./publish/* \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/medizid-web/
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOYMENT_EOF'
          set -e
          echo "Starting MedizID.Web Deployment..."
          
          # Install .NET 8 Runtime if not present
          if ! command -v dotnet &> /dev/null; then
            echo "Installing .NET 8 Runtime..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update
                sudo apt-get install -y dotnet-runtime-8.0
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y dotnet-runtime-8.0
              fi
            fi
            echo ".NET 8 Runtime installed"
          else
            echo ".NET 8 Runtime already installed"
          fi
          
          # Create systemd service file
          SERVICE_FILE="/etc/systemd/system/medizid-web.service"
          if [ ! -f "$SERVICE_FILE" ]; then
            echo "Creating systemd service..."
            sudo tee "$SERVICE_FILE" > /dev/null << 'SVCEOF'
          [Unit]
          Description=MedizID Web Service
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/medizid-web
          ExecStart=/opt/medizid-web/MedizID.Web
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=medizid-web
          Environment="ASPNETCORE_ENVIRONMENT=Production"
          Environment="ASPNETCORE_URLS=http://+:5001"
          
          [Install]
          WantedBy=multi-user.target
          SVCEOF
            sudo chmod 644 "$SERVICE_FILE"
            sudo systemctl daemon-reload
            sudo systemctl enable medizid-web
            echo "Systemd service created and enabled"
          else
            echo "Systemd service already exists"
            sudo systemctl daemon-reload
          fi
          
          # Install and configure Nginx
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update && sudo apt-get install -y nginx
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y nginx
              fi
            fi
            sudo systemctl enable nginx
            sudo systemctl start nginx
            echo "Nginx installed and started"
          else
            echo "Nginx already installed"
          fi
          
          # Configure Nginx virtual host
          NGINX_SITE="/etc/nginx/sites-available/medizid-web"
          NGINX_ENABLED="/etc/nginx/sites-enabled/medizid-web"
          if [ ! -f "$NGINX_SITE" ]; then
            echo "Creating Nginx virtual host..."
            sudo tee "$NGINX_SITE" > /dev/null << 'NGINXEOF'
          upstream medizid_web {
              server 127.0.0.1:5001;
              keepalive 32;
          }
          server {
              listen 80;
              server_name ec2-51-21-249-249.eu-north-1.compute.amazonaws.com;
              access_log /var/log/nginx/medizid-web.access.log;
              error_log /var/log/nginx/medizid-web.error.log;
              
              # Support Blazor WebAssembly routing
              location / {
                  proxy_pass http://medizid_web;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
                  proxy_cache_bypass $http_upgrade;
                  
                  # Handle WebSocket for Blazor Server if used
                  if ($http_upgrade = "websocket") {
                      proxy_pass http://medizid_web;
                  }
              }
              
              # Cache static files
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  proxy_pass http://medizid_web;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
          NGINXEOF
            sudo chmod 644 "$NGINX_SITE"
            if [ ! -d /etc/nginx/sites-enabled ]; then
              sudo mkdir -p /etc/nginx/sites-enabled
            fi
            sudo ln -sf "$NGINX_SITE" "$NGINX_ENABLED"
            echo "Nginx virtual host created"
          else
            echo "Nginx virtual host already exists"
          fi
          
          # Validate and reload Nginx
          if sudo nginx -t; then
            echo "Nginx configuration is valid"
            sudo systemctl reload nginx
            echo "Nginx reloaded"
          else
            echo "Nginx configuration has errors!"
            exit 1
          fi
          
          # Deploy application
          echo "Preparing application directory..."
          sudo mkdir -p /opt/medizid-web
          sudo cp -r ~/medizid-web/* /opt/medizid-web/
          sudo chown -R root:root /opt/medizid-web
          sudo chmod +x /opt/medizid-web/MedizID.Web
          
          # Restart service
          echo "Stopping existing application..."
          sudo systemctl stop medizid-web || true
          sleep 2
          
          echo "Starting application..."
          sudo systemctl start medizid-web
          sleep 3
          
          echo "Checking application status..."
          sudo systemctl status medizid-web
          echo "Deployment complete!"
          DEPLOYMENT_EOF

      - name: Verify deployment
        run: |
          sleep 5
          echo "Checking Web health..."
          curl -f http://${{ secrets.EC2_HOST }}:5001 || echo "Health check endpoint not available yet"
        continue-on-error: true

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Web application is running on http://${{ secrets.EC2_HOST }}:5001"
          else
            echo "❌ Deployment failed!"
          fi
