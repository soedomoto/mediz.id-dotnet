name: Build and Deploy MedizID.API

on:
  push:
    branches:
      - main
    paths:
      - 'MedizID.API/**'
      - 'MedizID.sln'
      - '.github/workflows/deploy-api.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore MedizID.sln

      - name: Build MedizID.API
        run: dotnet build MedizID.API/MedizID.API.csproj -c Release --no-restore

      - name: Run tests
        run: dotnet test MedizID.sln -c Release --no-build --verbosity normal
        continue-on-error: true

      - name: Publish MedizID.API
        run: dotnet publish MedizID.API/MedizID.API.csproj -c Release -o ./publish

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: medizid-api-release
          path: ./publish
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: medizid-api-release
          path: ./publish

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          echo "Stopping existing application..."
          sudo systemctl stop medizid-api || true
          sleep 2
          
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "mkdir -p ~/medizid-api"
          scp -r -i ~/.ssh/deploy_key ./publish/* \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/medizid-api/
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOYMENT_EOF'
          set -e
          echo "Starting MedizID.API Deployment..."
          
          # Install .NET 8 Runtime if not present
          if ! command -v dotnet &> /dev/null; then
            echo "Installing .NET 8 Runtime..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update
                sudo apt-get install -y dotnet-runtime-8.0
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y dotnet-runtime-8.0
              fi
            fi
            echo ".NET 8 Runtime installed"
          else
            echo ".NET 8 Runtime already installed"
          fi
          
          # Create systemd service file
          SERVICE_FILE="/etc/systemd/system/medizid-api.service"
          if [ ! -f "$SERVICE_FILE" ]; then
            echo "Creating systemd service..."
            sudo tee "$SERVICE_FILE" > /dev/null << 'SVCEOF'
          [Unit]
          Description=MedizID API Service
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/medizid-api
          ExecStart=/opt/medizid-api/MedizID.API
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=medizid-api
          Environment="DB_HOST=localhost"
          Environment="DB_PORT=5432"
          Environment="DB_NAME=mediz_db"
          Environment="DB_USER=postgres"
          Environment="DB_PASSWORD=@2Miawmiaw"
          Environment="ASPNETCORE_ENVIRONMENT=Production"
          Environment="ASPNETCORE_URLS=http://+:5000"
          Environment="JWT_SECRET_KEY=your-super-secret-key-at-least-32-characters-long-for-hmac256"
          Environment="JWT_ISSUER=mediz.id"
          Environment="JWT_AUDIENCE=mediz.id-api"
          Environment="JWT_EXPIRATION_MINUTES=1440"
          Environment="OPENAI_API_KEY=add-your-openai-api-key-here"
          
          [Install]
          WantedBy=multi-user.target
          SVCEOF
            sudo chmod 644 "$SERVICE_FILE"
            sudo systemctl daemon-reload
            sudo systemctl enable medizid-api
            echo "Systemd service created and enabled"
          else
            echo "Systemd service already exists"
            sudo systemctl daemon-reload
          fi
          
          # Install and configure Nginx
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update && sudo apt-get install -y nginx
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y nginx
              fi
            fi
            sudo systemctl enable nginx
            sudo systemctl start nginx
            echo "Nginx installed and started"
          else
            echo "Nginx already installed"
          fi
          
          # Configure Nginx virtual host
          NGINX_SITE="/etc/nginx/sites-available/medizid-api"
          NGINX_ENABLED="/etc/nginx/sites-enabled/medizid-api"
          if [ ! -f "$NGINX_SITE" ]; then
            echo "Creating Nginx virtual host..."
            sudo tee "$NGINX_SITE" > /dev/null << 'NGINXEOF'
          upstream medizid_backend {
              server 127.0.0.1:5000;
              keepalive 32;
          }
          server {
              listen 80;
              listen [::]:80;
              server_name _;
              access_log /var/log/nginx/medizid-api.access.log;
              error_log /var/log/nginx/medizid-api.error.log;
              location /api/ {
                  proxy_pass http://medizid_backend/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
                  proxy_cache_bypass $http_upgrade;
              }
              location /health {
                  proxy_pass http://medizid_backend/health;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  access_log off;
              }
              location /swagger/ {
                  proxy_pass http://medizid_backend/swagger/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }
              location / {
                  return 404;
              }
          }
          NGINXEOF
            sudo chmod 644 "$NGINX_SITE"
            if [ ! -d /etc/nginx/sites-enabled ]; then
              sudo mkdir -p /etc/nginx/sites-enabled
            fi
            sudo ln -sf "$NGINX_SITE" "$NGINX_ENABLED"
            echo "Nginx virtual host created"
          else
            echo "Nginx virtual host already exists"
          fi
          
          # Validate and reload Nginx
          if sudo nginx -t; then
            echo "Nginx configuration is valid"
            sudo systemctl reload nginx
            echo "Nginx reloaded"
          else
            echo "Nginx configuration has errors!"
            exit 1
          fi
          
          # Deploy application
          echo "Preparing application directory..."
          sudo mkdir -p /opt/medizid-api
          sudo cp -r ~/medizid-api/* /opt/medizid-api/
          sudo chown -R root:root /opt/medizid-api
          sudo chmod +x /opt/medizid-api/MedizID.API
          
          # Start service
          echo "Starting application..."
          sudo systemctl start medizid-api
          sleep 3
          
          echo "Checking application status..."
          sudo systemctl status medizid-api
          echo "Deployment complete!"
          DEPLOYMENT_EOF

      - name: Verify deployment
        run: |
          sleep 5
          echo "Checking API health..."
          curl -f http://${{ secrets.EC2_HOST }}:5000/health || echo "Health check endpoint not available yet"
        continue-on-error: true

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "API is running on http://${{ secrets.EC2_HOST }}:5000"
          else
            echo "❌ Deployment failed!"
          fi
