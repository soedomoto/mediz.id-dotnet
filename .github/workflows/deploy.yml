name: Build and Deploy MedizID

on:
  push:
    branches:
      - main
    paths:
      - 'MedizID.API/**'
      - 'MedizID.Web/**'
      - 'MedizID.UI/**'
      - 'MedizID.MAUI/**'
      - 'MedizID.sln'
      - '.github/workflows/deploy.yml'

jobs:
  build-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore MedizID.API/MedizID.API.csproj

      - name: Build MedizID.API
        run: dotnet build MedizID.API/MedizID.API.csproj -c Release --no-restore

      - name: Run tests
        run: dotnet test MedizID.sln -c Release --no-build --verbosity normal
        continue-on-error: true

      - name: Publish MedizID.API
        run: dotnet publish MedizID.API/MedizID.API.csproj -c Release -o ./publish-api

      - name: Compress API artifact
        run: tar -czf medizid-api-release.tar.gz -C ./publish-api . && ls -lh medizid-api-release.tar.gz

      - name: Upload API artifact
        uses: actions/upload-artifact@v4
        with:
          name: medizid-api-release
          path: medizid-api-release.tar.gz
          retention-days: 1

  build-web:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install wasm-tools workload
        run: dotnet workload install wasm-tools

      - name: Restore dependencies
        run: dotnet restore MedizID.Web/MedizID.Web.csproj

      - name: Build MedizID.Web
        run: dotnet build MedizID.Web/MedizID.Web.csproj -c Release --no-restore

      - name: Run tests
        run: dotnet test MedizID.sln -c Release --no-build --verbosity normal
        continue-on-error: true

      - name: Publish MedizID.Web
        run: dotnet publish MedizID.Web/MedizID.Web.csproj -c Release -o ./publish-web

      - name: Compress Web artifact
        run: tar -czf medizid-web-release.tar.gz -C ./publish-web . && ls -lh medizid-web-release.tar.gz

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        with:
          name: medizid-web-release
          path: medizid-web-release.tar.gz
          retention-days: 1

  build-maui:
    strategy:
      matrix:
        include:
          - os: macos-latest
            framework: net8.0-maccatalyst
            artifact-name: medizid-maui-maccatalyst
          - os: windows-latest
            framework: net8.0-windows10.0.19041.0
            artifact-name: medizid-maui-windows
          - os: ubuntu-latest
            framework: net8.0-android
            artifact-name: medizid-maui-android
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet workload restore

      - name: Build MedizID.MAUI
        run: dotnet build MedizID.MAUI/MedizID.MAUI.csproj -f ${{ matrix.framework }} -c Release

      - name: Publish MedizID.MAUI
        run: dotnet publish MedizID.MAUI/MedizID.MAUI.csproj -f ${{ matrix.framework }} -c Release -o ./publish-maui

      - name: Compress artifact
        shell: bash
        run: tar -czf ${{ matrix.artifact-name }}-release.tar.gz -C ./publish-maui . && ls -lh ${{ matrix.artifact-name }}-release.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}-release
          path: ${{ matrix.artifact-name }}-release.tar.gz
          retention-days: 7

  deploy:
    needs: [build-api, build-web]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download API artifact
        uses: actions/download-artifact@v4
        with:
          name: medizid-api-release
          path: ./artifacts

      - name: Download Web artifact
        uses: actions/download-artifact@v4
        with:
          name: medizid-web-release
          path: ./artifacts

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Upload artifacts and deploy
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "mkdir -p ~/medizid-api ~/medizid-web"
          echo "Uploading API artifact..."
          scp -i ~/.ssh/deploy_key ./artifacts/medizid-api-release.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/medizid-api-release.tar.gz
          echo "Uploading Web artifact..."
          scp -i ~/.ssh/deploy_key ./artifacts/medizid-web-release.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/medizid-web-release.tar.gz
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOYMENT_EOF'
          set -e
          echo "Starting MedizID Deployment..."
          
          # Install .NET 8 Runtime if not present
          if ! command -v dotnet &> /dev/null; then
            echo "Installing .NET 8 Runtime..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update
                sudo apt-get install -y dotnet-runtime-8.0
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y dotnet-runtime-8.0
              fi
            fi
            echo ".NET 8 Runtime installed"
          else
            echo ".NET 8 Runtime already installed"
          fi
          
          # Create systemd service file for API
          SERVICE_FILE="/etc/systemd/system/medizid-api.service"
          if [ ! -f "$SERVICE_FILE" ]; then
            echo "Creating systemd service for API..."
            sudo tee "$SERVICE_FILE" > /dev/null << 'SVCEOF'
          [Unit]
          Description=MedizID API Service
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/medizid-api
          ExecStart=/opt/medizid-api/MedizID.API
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=medizid-api
          Environment="DB_HOST=localhost"
          Environment="DB_PORT=5432"
          Environment="DB_NAME=mediz_db"
          Environment="DB_USER=postgres"
          Environment="DB_PASSWORD=@2Miawmiaw"
          Environment="ASPNETCORE_ENVIRONMENT=Production"
          Environment="ASPNETCORE_URLS=http://+:5000"
          Environment="JWT_SECRET_KEY=your-super-secret-key-at-least-32-characters-long-for-hmac256"
          Environment="JWT_ISSUER=mediz.id"
          Environment="JWT_AUDIENCE=mediz.id-api"
          Environment="JWT_EXPIRATION_MINUTES=1440"
          Environment="OPENAI_API_KEY=add-your-openai-api-key-here"
          
          [Install]
          WantedBy=multi-user.target
          SVCEOF
            sudo chmod 644 "$SERVICE_FILE"
            sudo systemctl daemon-reload
            sudo systemctl enable medizid-api
            echo "Systemd service for API created and enabled"
          else
            echo "Systemd service for API already exists"
            sudo systemctl daemon-reload
          fi
          
          # Note: MedizID.Web is a Blazor WebAssembly client-side app
          # It will be served as static files from wwwroot through Nginx
          # No systemd service needed for Web
          
          # Install and configure Nginx
          if ! command -v nginx &> /dev/null; then
            echo "Installing Nginx..."
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              if [[ "$ID" == "ubuntu" ]] || [[ "$ID" == "debian" ]]; then
                sudo apt-get update && sudo apt-get install -y nginx
              elif [[ "$ID" == "rhel" ]] || [[ "$ID" == "centos" ]] || [[ "$ID" == "fedora" ]]; then
                sudo dnf install -y nginx
              fi
            fi
            sudo systemctl enable nginx
            sudo systemctl start nginx
            echo "Nginx installed and started"
          else
            echo "Nginx already installed"
          fi
          
          # Configure Nginx virtual host
          NGINX_SITE="/etc/nginx/sites-available/medizid"
          NGINX_ENABLED="/etc/nginx/sites-enabled/medizid"
          
          echo "Creating/Updating Nginx virtual host..."
          sudo tee "$NGINX_SITE" > /dev/null << 'NGINXEOF'
          upstream medizid_api {
              server 127.0.0.1:5000;
              keepalive 32;
          }
          
          server {
              listen 80;
              listen [::]:80;
              server_name ec2-51-21-249-249.eu-north-1.compute.amazonaws.com mediz.soedomoto.com;
              access_log /var/log/nginx/medizid.access.log;
              error_log /var/log/nginx/medizid.error.log;

              root /var/www/medizid-web/wwwroot;
              index index.html;
              
              # API endpoints
              location /api/ {
                  proxy_pass http://medizid_api/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
                  proxy_cache_bypass $http_upgrade;
              }
              
              # Health check endpoint
              location /health {
                  proxy_pass http://medizid_api/health;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  access_log off;
              }
              
              # Swagger documentation
              location /swagger/ {
                  proxy_pass http://medizid_api/swagger/;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }

              location / {
                  try_files $uri $uri/ /index.html;
              }

              # Blazor DLLs, WASM, JSON, etc.
              location /_framework/ {
                  try_files $uri =404;
              }

              # Cache static assets aggressively (optional but recommended)
              location ~* \.(css|js|wasm|json|ico|png|jpg|jpeg|gif|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }

              # Gzip compression (recommended)
              gzip on;
              gzip_static on;
              gzip_types text/plain text/css application/javascript application/json application/octet-stream;

          }
          NGINXEOF
          
          sudo chmod 644 "$NGINX_SITE"
          if [ ! -d /etc/nginx/sites-enabled ]; then
            sudo mkdir -p /etc/nginx/sites-enabled
          fi
          
          # Create symbolic link if it doesn't exist, or update existing
          if [ ! -L "$NGINX_ENABLED" ]; then
            sudo ln -sf "$NGINX_SITE" "$NGINX_ENABLED"
            echo "Nginx site symlink created"
          else
            echo "Nginx site symlink already exists"
          fi
          
          # Validate and reload Nginx
          if sudo nginx -t; then
            echo "Nginx configuration is valid"
            sudo systemctl reload nginx
            echo "Nginx reloaded"
          else
            echo "Nginx configuration has errors!"
            exit 1
          fi
          
          # Stop existing services
          echo "Stopping existing applications..."
          sudo systemctl stop medizid-api || true
          sleep 2
          
          # Extract and deploy artifacts
          echo "Extracting API artifact..."
          sudo mkdir -p /opt/medizid-api
          sudo tar -xzf ~/medizid-api-release.tar.gz -C /opt/medizid-api
          sudo chown -R root:root /opt/medizid-api
          sudo chmod +x /opt/medizid-api/MedizID.API
          
          echo "Extracting Web artifact (static files)..."
          sudo mkdir -p /var/www/medizid-web
          sudo tar -xzf ~/medizid-web-release.tar.gz -C /var/www/medizid-web
          sudo chown -R www-data:www-data /var/www/medizid-web
          sudo chmod -R 755 /var/www/medizid-web
          
          # Clean up compressed files
          rm -f ~/medizid-api-release.tar.gz ~/medizid-web-release.tar.gz
          
          # Start services
          echo "Starting API application..."
          sudo systemctl start medizid-api
          sleep 2
          
          echo "Checking application status..."
          echo "=== API Status ==="
          sudo systemctl status medizid-api
          echo ""
          echo "Web application (Blazor WebAssembly) served as static files by Nginx"
          echo "Deployment complete!"
          DEPLOYMENT_EOF

      - name: Verify deployment
        run: |
          sleep 5
          echo "Checking API health..."
          curl -f http://${{ secrets.EC2_HOST }}/health || echo "API health check endpoint not available yet"
          echo ""
          echo "Checking Web application..."
          curl -f http://${{ secrets.EC2_HOST }}/ || echo "Web application not available yet"
        continue-on-error: true

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "API is running on http://${{ secrets.EC2_HOST }}/api"
            echo "Web application is running on http://${{ secrets.EC2_HOST }}/"
            echo "Swagger documentation at http://${{ secrets.EC2_HOST }}/swagger/"
            echo ""
            echo "MAUI apps available as GitHub artifacts:"
            echo "  - macCatalyst: medizid-maui-maccatalyst-release"
            echo "  - Windows: medizid-maui-windows-release"
            echo "  - Android: medizid-maui-android-release"
          else
            echo "❌ Deployment failed!"
          fi
